<!DOCTYPE html>
<html>
<head>
	<title>Youtube con amigos</title>
	
	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

	<!-- Optional theme -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

	<!-- Latest compiled and minified JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
	
</head>
  <body class="container">
    <!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
	<div class="col-sm-8">
		<div id="player"></div></br></br>
		<button class="btn btn-success" onclick="play()"><span class="glyphicon glyphicon-play"></span></button>
		<button class="btn btn-default" onclick="pausa()"><span class="glyphicon glyphicon-pause"></span></button>
		<button class="btn btn-danger" onclick="stop()"><span class="glyphicon glyphicon-stop"></span></button>
		<button class="btn btn-default" onclick="siguiente()"><span class="glyphicon glyphicon-step-forward"></span></button></br></br>
		<div class="input-group">
			<input type="text" class="form-control" id="textoBuscar" placeholder="Buscar">
			<div class="input-group-btn">
				<button class="btn btn-default" onclick="buscar()">
					<i class="glyphicon glyphicon-search"></i>
				</button>
			</div>
		</div>
		<div id="resultados"></div></br></br>
	</div>
	<div class="col-sm-4">
		Lista
		<div id="lista"></div>
	</div>
	
	<script src="https://www.gstatic.com/firebasejs/3.6.4/firebase.js"></script>
    <script>
		// Initialize Firebase
		var config = {
			apiKey: "AIzaSyCiC2SIqEfngJopZ8KLjAhui7uJ8MwGbeg",
			authDomain: "youtubeconamigos-153119.firebaseapp.com",
			databaseURL: "https://youtubeconamigos-153119.firebaseio.com",
			storageBucket: "youtubeconamigos-153119.appspot.com",
			messagingSenderId: "4360677184"
		};
		firebase.initializeApp(config);
		
		// Get a reference to the database service
		var database = firebase.database();
		
		var listaRef = database.ref('lista');
		listaRef.on('child_added', function(snapshot) {
			var tema = new Object();
			tema.id = snapshot.key;
			tema.idYoutube = snapshot.val().id;
			tema.nombre = snapshot.val().nombre;
			agregaralista(tema);
		});
		
		listaRef.on('child_removed', function(snapshot) {
			lista.shift();
			// Create the list element:
			var ul = document.createElement('ul');
			
			for(var i = 0; i < lista.length; i++) {
				// Create the list item:
				var item = document.createElement('li');
			
				// Set its contents:
				item.appendChild(document.createTextNode(lista[i].nombre));
			
				// Add it to the list:
				ul.appendChild(item);
			}
			document.getElementById('lista').innerHTML = '';
			document.getElementById('lista').appendChild(ul);
		});
		
		// 2. This code loads the IFrame Player API code asynchronously.
		var tag = document.createElement('script');

		tag.src = "https://www.youtube.com/iframe_api";
		var firstScriptTag = document.getElementsByTagName('script')[0];
		firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

		// 3. This function creates an <iframe> (and YouTube player)
		//    after the API code downloads.
		var player;
		function onYouTubeIframeAPIReady() {
			player = new YT.Player('player', {
				height: '360',
				width: '640',
				videoId: 'R88lUBvbjPo',
				events: {
					'onReady': onPlayerReady,
					'onStateChange': onPlayerStateChange,
					'onError': siguiente
				}
			});
		}

		// 4. The API will call this function when the video player is ready.
		function onPlayerReady(event) {
			//event.target.playVideo();
		}

		// 5. The API calls this function when the player's state changes.
		function onPlayerStateChange(event) {
			if(player.getPlayerState() == 0 && lista.length > 0){
				siguiente();
			};
		}
		  
		var lista = [];
		function agregaralalista(){
			var id = document.getElementById("id").value;
			lista.push(id);
			// Create the list element:
			var ul = document.createElement('ul');
		
			for(var i = 0; i < lista.length; i++) {
				// Create the list item:
				var item = document.createElement('li');
		
				// Set its contents:
				item.appendChild(document.createTextNode(lista[i]));
		
				// Add it to the list:
				ul.appendChild(item);
			}
			document.getElementById('lista').innerHTML = '';
			document.getElementById('lista').appendChild(ul);
			id.innerHTML = '';
			if(player.getPlayerState() == 0){
				siguiente();
			}
		}
		  
		function siguiente(){
			//player.nextVideo();
			if(lista.length > 0){
				player.loadVideoById(lista[0].idYoutube,0,"large");
				listaRef.child(lista[0].id).remove();
			}
		}
		  
		function play(){
			player.playVideo();
		}
		  
		function pausa(){
			player.pauseVideo();
		}
		  
		function stop(){
			player.stopVideo();
		}
		  
		function buscar() {
			var q = document.getElementById("textoBuscar").value;
			var request = "https://www.googleapis.com/youtube/v3/search?part=snippet&q="+q+"&type=video&maxResults=50&key=AIzaSyDnwBzhbCjNQUC5qf53gTEP8qlg3UCJF3M"
			
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					var json = JSON.parse(this.response);
					document.getElementById("resultados").innerHTML = '';
					for(var i = 0; i < json.items.length; i++){
						var a = document.createElement("A");
						a.innerHTML = json.items[i].snippet.title + '</br>';
						a.href = '#';
						a.id = json.items[i].id.videoId;
						a.addEventListener("click", function(){agregarbuscado(this.id, this.text); document.getElementById("resultados").innerHTML = '';});
						document.getElementById("resultados").appendChild(a);
					}
				}
			};
			xhttp.open("GET", request, true);
			xhttp.send();
		}
		
		function agregarbuscado(id, nombre){
			var tema = new Object();
			tema.id = id;
			tema.nombre = nombre;
			listaRef.push(tema);
		}
		  
		function agregaralista(tema){
			lista.push(tema);
			// Create the list element:
			var ul = document.createElement('ul');
		
			for(var i = 0; i < lista.length; i++) {
				// Create the list item:
				var item = document.createElement('li');
		
				// Set its contents:
				item.appendChild(document.createTextNode(lista[i].nombre));
		
				// Add it to the list:
				ul.appendChild(item);
			}
			document.getElementById('lista').innerHTML = '';
			document.getElementById('lista').appendChild(ul);
			if(player.getPlayerState() == 0){
				siguiente();
			}
		}
    </script>
  </body>
</html>